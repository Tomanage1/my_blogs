<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.exam.myblogs.mapper.ArticleMapper">

    <!-- 分页查询文章列表 -->
    <select id="selectArticles" resultMap="ArticleBaseResultMap">
        SELECT
            a.*,
            c.name AS category_name,
            COUNT(l.id) AS likes_count
        FROM article a
                 LEFT JOIN category c ON a.category_id = c.id
                 LEFT JOIN likes l ON a.id = l.article_id
        GROUP BY a.id
        ORDER BY a.created_at DESC
    </select>

    <!-- 根据标题搜索文章 -->
    <select id="searchArticlesByTitle" resultMap="ArticleBaseResultMap">
        SELECT
            a.*,
            c.name AS category_name,
            COUNT(l.id) AS likes_count
        FROM article a
                 LEFT JOIN category c ON a.category_id = c.id
                 LEFT JOIN likes l ON a.id = l.article_id
        WHERE a.title LIKE CONCAT('%', #{title}, '%')
        GROUP BY a.id
        ORDER BY a.created_at DESC
    </select>

    <!-- 根据文章ID查询文章详情（包含标签信息） -->
    <select id="selectArticleWithTagsById" resultMap="ArticleDetailResultMap">
        SELECT
        a.*,
        c.name AS category_name,
        COUNT(l.id) AS likes_count,
        t.name AS tag_name
        FROM article a
        LEFT JOIN category c ON a.category_id = c.id
        LEFT JOIN likes l ON a.id = l.article_id
        LEFT JOIN article_tag at ON a.id = at.article_id
        LEFT JOIN tag t ON at.tag_id = t.id
        WHERE a.id = #{id}
        GROUP BY a.id, t.id  <!-- 确保每个标签只出现一次 -->
    </select>

    <!-- 基础结果映射 -->
    <resultMap id="ArticleBaseResultMap" type="com.exam.myblogs.entity.Article">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="summary" column="summary"/>
        <result property="authorId" column="author_id"/>
        <result property="status" column="status"/>
        <result property="view" column="view"/>  <!-- 直接映射articles表的view字段 -->
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

        <!-- 映射分类名称 -->
        <result property="category" column="category_name"/>

        <!-- 映射元数据（点赞数） -->
        <association property="meta" javaType="com.exam.myblogs.entity.Article$Meta">
            <result property="likes" column="likes_count"/>
        </association>
    </resultMap>

    <!-- 详细结果映射（包含标签） -->
    <resultMap id="ArticleDetailResultMap" type="com.exam.myblogs.entity.Article" extends="ArticleBaseResultMap">
        <!-- 集合映射标签 -->
        <collection property="tags" ofType="java.lang.String">
            <result property="name" column="tag_name"/>
        </collection>
    </resultMap>
</mapper>